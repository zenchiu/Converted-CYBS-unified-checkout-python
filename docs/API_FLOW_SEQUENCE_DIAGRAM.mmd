%% Unified Checkout API Flow & JWT Sequence Diagram
%% Mermaid source - can be rendered in Mermaid Live Editor, GitHub, or VS Code

sequenceDiagram
    participant User as User Browser
    participant Flask as Flask App
    participant CyberSource as CyberSource API
    participant Widget as UC Widget (Flex SDK)
    participant Issuer as Card Issuer (3DS/ACS)

    %% --- Phase 1: Capture Context ---
    User->>Flask: GET /ucoverview
    Flask-->>User: Preset selector, JSON editor

    User->>Flask: POST /capture-context (captureContextRequest JSON)
    Flask->>CyberSource: POST /up/v1/capture-contexts
    CyberSource-->>Flask: Capture Context JWT
    Note over Flask: _decode_jwt_payload() extracts ctx, clientLibrary, integrity
    Flask-->>User: capture_context.html (JWT + decoded payload)

    %% --- Phase 2: Checkout ---
    User->>Flask: POST /checkout (captureContext, captureContextDecoded)
    Note over Flask: Extract clientLibrary URL from decoded JWT payload
    Flask-->>User: checkout.html (capture_context JWT, clientLibrary URL)

    %% --- Phase 3: Widget & Payment (Step 6 onward) ---
    User->>Widget: Load SDK from clientLibrary URL (from JWT)
    Note right of User: Step 6: script.src=clientLibrary, flexSetup()
    User->>Widget: Accept(captureContextJWT), up.show()
    Note right of User: Step 7: Accept(cc), up.show() → tt
    Widget-->>User: tt (transient token)

    User->>Widget: up.complete(tt)
    Note right of User: Step 8: up.complete(tt)

    rect rgb(240, 248, 255)
        Note over Widget,Issuer: completeMandate orchestration
        Widget->>CyberSource: 3DS enrollment check
        Widget->>Issuer: 3DS challenge (if step-up)
        Issuer-->>Widget: OTP verification
        Widget->>CyberSource: Payment authorization
        Widget->>CyberSource: TMS token creation
    end

    Widget-->>User: Result JWT
    Note right of User: Step 9: completeResponse, authForm.submit()
    User->>Flask: POST /process-payment (response=Result JWT)
    Note over Flask: Step 11: process_payment(), _decode_jwt_payload()
    Flask-->>User: complete_response.html (AUTHORIZED/DECLINED/ERROR)

%% =============================================================================
%% FUNCTIONS INVOLVED (Step 6 onwards)
%% =============================================================================
%%
%% Step 6: Load UC SDK
%%   File: templates/checkout.html
%%   - script.src = clientLibrary (from decoded JWT ctx[0].data)
%%   - script.integrity = clientLibraryIntegrity
%%   - onload → flexSetup()
%%
%% Step 7: Widget Accept → show → tt
%%   File: templates/checkout.html
%%   - flexSetup() — async, runs when SDK loads
%%   - Accept(cc) — Flex SDK init with capture context JWT
%%   - accept.unifiedPayments(sidebar) — returns UC instance
%%   - up.show(showArgs) — displays payment UI, returns tt (transient token)
%%
%% Step 8: Orchestration
%%   File: templates/checkout.html
%%   - up.complete(tt) — Flex SDK orchestrates 3DS → auth → TMS
%%
%% Step 9–10: Submit Result JWT
%%   File: templates/checkout.html
%%   - completeResponse = await up.complete(tt)
%%   - response.value = completeResponse
%%   - authForm.submit() → POST /process-payment with response=Result JWT
%%
%% Step 11: Decode and Display
%%   File: app.py
%%   - process_payment() — request.form.get("response"), _decode_jwt_payload()
%%   - _decode_jwt_payload(jwt_token) — base64 decode payload
%%   - render_template("complete_response.html", ...)
