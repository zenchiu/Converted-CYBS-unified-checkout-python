# CyberSource Unified Checkout - Python/Flask Sample

A Python conversion of the [CyberSource Unified Checkout Node.js sample](https://github.com/CyberSource/cybersource-unified-checkout-sample-node). This application demonstrates integrating CyberSource Unified Checkout using the [cybersource-rest-client-python](https://github.com/CyberSource/cybersource-rest-client-python) SDK.

> **Disclaimer:** This is not an official CyberSource example. I am a developer who based this on the [CyberSource Node.js sample](https://github.com/CyberSource/cybersource-unified-checkout-sample-node/tree/main) and have no relationship with CyberSource.

## Prerequisites

- **Python 3.7+**
- A CyberSource sandbox account ([register here](https://developer.cybersource.com/))
- Merchant credentials (Merchant ID, Key ID, Secret Key)

## Installation

1. **Create a virtual environment** (recommended):

   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```

2. **Install dependencies**:

   ```bash
   pip install -r requirements.txt
   ```

   **Python 3.12+:** Run this first (setuptools and standard-imghdr must be installed before the rest, since `imghdr` was removed in 3.13):

   ```bash
   pip install "setuptools<81" standard-imghdr
   pip install -r requirements.txt
   ```

3. **Configure your merchant credentials**:

   Copy the example config and add your CyberSource credentials:

   ```bash
   cp config.ini.example config.ini
   ```

   Edit `config.ini` and set your values:

   ```ini
   [CyberSource]
   merchant_id = your_merchant_id
   key_id = your_key_id
   secret_key = your_secret_key
   run_environment = apitest.cybersource.com

   [App]
   port = 5000
   ```

## Running the Application

```bash
python app.py
```

The application starts an HTTPS server at **https://localhost:5000**.

## Full End-to-End Test (including browser)

The test uses Playwright to automate the full flow: Home → UC Overview → Capture Context → Checkout → Payment Widget → Card Entry → Confirm → Payment Result.

**1. Install test dependencies:**

```bash
pip install playwright
playwright install chromium
```

**2. Run the test** (start the app in another terminal first: `python app.py`):

```bash
# Headless (default)
python test_e2e.py

# Visible browser
python test_e2e.py --headed
```

**3. Or use the test runner** (starts server, runs test, stops server):

```bash
./run_e2e_test.sh           # Headless
./run_e2e_test.sh --headed  # Visible browser
```

**4. Card-only-token-with-prefix test** (uses `default-uc-capture-context-request-card-only-token-with-prefix.json`):
- Ticks Save card checkbox
- Enters OTP 1234 when OTP screen shows

```bash
./run_e2e_card_only_token_test.sh           # Headless
./run_e2e_card_only_token_test.sh --headed  # Visible browser
```

**5. No-3DS-token-with-prefix test** (uses `default-uc-capture-context-request-no-3ds-token-with-prefix.json`):
- No 3DS (consumerAuthentication: false), tokenCreate, includeCardPrefix
- Ticks Save card checkbox
- No OTP step — use when COMPLETE_AUTHENTICATION_FAILED or Payer Auth not enabled

```bash
./run_e2e_no_3ds_token_test.sh           # Headless
./run_e2e_no_3ds_token_test.sh --headed  # Visible browser
```

Screenshots are saved to `test_screenshots/`. E2E logs (e.g. `e2e_run_log.txt`, `e2e_no_3ds_token_log.txt`) are generated by the run scripts. These and `log/` (CyberSource SDK) are gitignored.

**Test cards:** The test uses Visa `4000 0000 0000 2503` (4000000000002503) or Mastercard `5200 0000 0000 1096` (5200000000001096). Expiry: 12/2026, CVV: 123. Visa 4000000000002503 triggers 3DS step-up challenge. Use `E2E_TEST_CARD=5200000000001096` to test with Mastercard.

**Payer Authentication must be enabled:** Your CyberSource sandbox merchant must have Payer Authentication (EMV 3-D Secure) enabled. Enable it in Business Center → Payment Configuration, or contact CyberSource support.

**COMPLETE_AUTHENTICATION_FAILED / Consumer Authentication failure:** If you see this error, your merchant likely does not have 3DS enabled. Use the **no 3ds** preset on the UC Overview page to test without 3DS (`consumerAuthentication: false`). See [docs/OTP_FLOW_VERIFICATION.md](docs/OTP_FLOW_VERIFICATION.md#troubleshooting-complete_authentication_failed) for details.

**OTP / Step-Up flow:** See [docs/OTP_FLOW_VERIFICATION.md](docs/OTP_FLOW_VERIFICATION.md) for documentation verification and how to maximize the chance of triggering the 3DS challenge (OTP).

**"No such issuer" / DECLINED:** If the test fails with `PROCESSOR_ERROR` or "No such issuer", your sandbox merchant may not be configured for test cards. Options: (1) Check CyberSource Business Center → Payment Configuration for your processor, (2) Contact CyberSource support to enable test card processing, (3) Use `E2E_ALLOW_DECLINED=1` to run the test without requiring AUTHORIZED.

> **Note**: The included SSL certificates (`certs/server.cert` and `certs/server.key`) are self-signed for development purposes. Your browser will show a security warning — this is expected for local testing.

## Capture Context Configuration

The app provides several capture context presets in `data/`. On the UC Overview page, use the **Capture context preset** dropdown to select one, then edit the JSON as needed before generating.

| Config file | Description |
|-------------|-------------|
| `default-uc-capture-context-request.json` | Default: Click to Pay, Google Pay, AUTH flow |
| `default-uc-capture-context-request-no-3ds.json` | No 3DS (`consumerAuthentication: false`) — use when COMPLETE_AUTHENTICATION_FAILED |
| `default-uc-capture-context-request-no-3ds-token-with-prefix.json` | No 3DS + tokenCreate + includeCardPrefix + requestSaveCard |
| `default-uc-capture-context-request-card-only-with-prefix.json` | Card entry only (PANENTRY), `includeCardPrefix: true` |
| `default-uc-capture-context-request-card-only-token-with-prefix.json` | Card + digital wallets, TMS token creation, `includeCardPrefix: true` |

**To add or update presets:**

1. Add or edit JSON files in `data/` matching `default-uc-capture-context-request*.json`
2. The app auto-discovers new files — refresh the UC Overview page to see them
3. Update `targetOrigins` in each config to match your domain (e.g. `https://localhost:5000`, `https://127.0.0.1:5000`)
4. Adjust `country`, `locale`, `allowedCardNetworks`, `allowedPaymentTypes`, and `orderInformation` as needed for your use case

## Application Flow

1. **Home page** (`/`) — Choose use case
2. **Overview** (`/ucoverview`) — Select preset, view/edit the capture context request JSON
3. **Generate Capture Context** (`POST /capture-context`) — Calls CyberSource API to generate a JWT capture context
4. **Checkout** (`POST /checkout`) — Loads the Unified Checkout widget with the capture context
5. **Process Payment** (`POST /process-payment`) — Receives the complete mandate result from the widget (3DS + auth + TMS)

### 3DS / Payer Authentication Flow (completeMandate)

The application uses **Unified Checkout completeMandate** with `consumerAuthentication: true`:

```
Unified Checkout Widget (completeMandate with consumerAuthentication: true)
  │
  ▼  up.show() captures card → up.complete(tt) orchestrates:
  │    1. Payer Authentication (3DS) — enrollment check, then challenge if required
  │    2. Payment authorization
  │    3. TMS token creation
  │
  ▼  Widget submits form to /process-payment with orchestrated result JWT
  │
  └─ AUTHORIZED / DECLINED / ERROR  →  Payment result page
```

- **Frictionless 3DS:** Cardholder authenticated silently; no challenge shown.
- **Step-up challenge:** Cardholder sees OTP/verification in an iframe; completes it; widget continues.

## Project Structure

```
unified-checkout-python/
├── app.py                          # Main Flask application
├── config.ini.example               # Example config (copy to config.ini)
├── requirements.txt                # Python dependencies
├── README.md                       # This file
├── test_e2e.py                     # Default E2E test
├── test_e2e_card_only_token.py     # E2E test (card-only-token-with-prefix, OTP 1234)
├── test_e2e_no_3ds_token.py       # E2E test (no-3ds-token-with-prefix)
├── run_e2e_test.sh                 # Run default E2E test
├── run_e2e_card_only_token_test.sh # Run card-only-token E2E test
├── run_e2e_no_3ds_token_test.sh    # Run no-3DS E2E test
├── certs/
│   ├── server.cert                 # SSL certificate (self-signed)
│   └── server.key                  # SSL private key
├── data/
│   ├── __init__.py
│   ├── configuration.py            # CyberSource merchant configuration
│   ├── default-uc-capture-context-request.json
│   ├── default-uc-capture-context-request-no-3ds.json
│   ├── default-uc-capture-context-request-no-3ds-token-with-prefix.json
│   ├── default-uc-capture-context-request-card-only-with-prefix.json
│   └── default-uc-capture-context-request-card-only-token-with-prefix.json
├── Resource/
│   └── NetworkTokenCert.pem        # PEM cert for JWE decryption
├── templates/
│   ├── index.html                  # Home page
│   ├── uc_overview.html            # Capture context request editor
│   ├── capture_context.html        # Capture context display
│   ├── checkout.html               # Checkout page with UC widget
│   ├── step_up.html                # 3DS step-up challenge page
│   ├── complete_response.html      # Payment result page
│   └── error.html                  # Error page
├── static/
│   └── stylesheets/
│       └── style.css               # Custom styles
├── test_screenshots/               # E2E screenshots (gitignored)
└── log/                            # CyberSource SDK logs (gitignored)
```

## Environment Configuration

By default, the application connects to the CyberSource **sandbox** environment (`apitest.cybersource.com`). To switch to production, update `run_environment` in `config.ini`:

```ini
run_environment = api.cybersource.com
```

> **Important**: API credentials differ between sandbox and production. Ensure you use the correct credentials for each environment.

## Key Differences from the Node.js Version

| Aspect | Node.js | Python |
|---|---|---|
| Framework | Express | Flask |
| Template Engine | EJS | Jinja2 |
| Port | 3000 | 5000 |
| CyberSource SDK | `cybersource-rest-client` (npm) | `cybersource-rest-client-python` (pip) |
| API Call Style | Callback-based | Synchronous |

## License

See the [LICENSE](LICENSE) file for details.
